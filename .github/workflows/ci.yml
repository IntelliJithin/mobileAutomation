name: Mobile automation test
 
on:
  workflow_dispatch:
 
jobs:
  build:
    runs-on: ubuntu-latest
 
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4
 
      - name: üê¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
 
      - name: Clean node_modules and package-lock.json
        run: |
          rm -rf node_modules
          rm package-lock.json
          npm install # Reinstall dependencies cleanly
 
      - name: üèóÔ∏è Install Dependencies
        run: npm install
 
      - name: Install Appium and drivers
        run: |
          echo "Checking currently installed Appium driver..."
          if ! command -v appium &> /dev/null; then
           echo "Appium not found. Installing..."
           npm install -g appium
          fi
          
          INSTALLED_DRIVERS=$(appium driver list --installed 2>&1 || echo "Error: Appium command failed")

          if echo "$INSTALLED_DRIVERS" | grep -q "uiautomator2"; then
           echo "uiautomator2 is already installed. Skipping reinstallation."
          else
           echo "uiautomator2 not found. Reinstalling Appium and drivers..."
           appium driver install uiautomator2
          fi
                    
      - name: Install Java
        run: sudo apt-get install -y openjdk-11-jdk
 
      - name: Install Android SDK and Setup Path
        run: |
         echo "üì• Installing Android SDK & dependencies..."
         sudo apt-get update
         sudo apt-get install -y wget unzip
 
         echo "üì• Downloading Android command-line tools..."
         wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
 
         echo "üìÇ Extracting Android command-line tools..."
         mkdir -p $HOME/android-sdk/cmdline-tools
         unzip -q commandlinetools-linux-11076708_latest.zip -d $HOME/android-sdk/cmdline-tools
         mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
 
         echo "üîß Setting environment variables..."
         echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
         echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH" >> $GITHUB_ENV
 
         # Reload the environment variables
         source $GITHUB_ENV
 
         echo "üìå Verifying sdkmanager existence..."
         if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
         echo "‚úÖ sdkmanager found!"
         else
         echo "‚ùå ERROR: sdkmanager not found!"
         exit 1
         fi
 
         echo "‚úÖ Accepting licenses..."
         yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || echo "‚ö†Ô∏è License acceptance failed"
 
         echo "üì• Installing required SDK packages..."
         $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platform-tools" "build-tools;34.0.0" "platforms;android-34" "system-images;android-34;google_apis;x86_64"
 
         echo "üìå Listing installed SDK components..."
         $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list

      - name: Install Vulkan and OpenGL libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y libvulkan1 mesa-utils   

      - name: Fix KVM permissions
        run: |
          echo "Fixing KVM permissions to enable hardware acceleration..."
          sudo apr-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils

          echo "Ensuring KVM group exists..."
          if ! grep -q "^kvm:" /etc/group; then
            sudo groupadd -r kvm
          fi

          echo "Adding current user to KVM group..."
          sudo gpasswd -a $USER kvm

          echo "Changing /dev/kvm permissions..."
          sudo chown root:kvm /dev/kvm
          sudo chmod 660 /dev/kvm

          echo "Restarting libvirt service..."
          sudo systemctl enable libvirtd
          sudo systemctl start libvirtd

          echo "Verifying KVM access..."
          if ! ls /dev/kvm; then
            echo "ERROR: KVM device not found. Make sure virtualization is enabled in your system."
            exit 1
          fi

          echo "KVM setup completed successfully!"

      - name: Verify SDK Installation
        run: |
          echo "Checking Android SDK paths..."
          ls -la $ANDROID_HOME
          ls -la $ANDROID_HOME/platforms
          ls -la $ANDROID_HOME/system-images/android-34

          echo "Checking available SDK packages..."
          sdkmanager --list || echo "sdkmanager command failed"
 
      - name: Set up Android Emulator
        run: |
          echo "üìå Checking if AVD already exists..."
          if $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd | grep -q "test_emulator"; then
          echo "‚úÖ AVD already exist!"
          else
          echo "üìå Creating AVD with android 34..."
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n test_emulator -k "system-images;android-34;google_apis;x86_64" --device "pixel"
          fi

          echo "üìå Setting AVD Path..."
          export ANDROID_AVD_HOME=$HOME/.config/.android/avd
          echo "ANDROID_AVD_HOME=$ANDROID_AVD_HOME" >> $GITHUB_ENV

          echo "üìå Listing available AVDs..."
          $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list avd

          echo "Ensureing ADB is running..."
          $ANDROID_HOME/platform-tools/adb start-server

           
          echo "üì¢ Starting emulator..."
          nohup $ANDROID_HOME/emulator/emulator -avd test_emulator -no-window -noaudio -no-boot-anim -gpu swiftshader_indirect -no-snapshot -qemu -vnc :1 > emulator.log 2>&1 &
          sleep 5

          echo "Checking if emulator process is running..."
          if ! pgrep -f "emulator" > /dev/null; then
           echo "Emulator failed to start! Check emulator.log for details."
           cat emulator.log
           exit 1
          fi

          echo "Listing connected devices/emulators (before waiting)..."
          adb devices

          echo "‚è≥ Waiting for emulator to start..."
          START_TIME=$(date +%s)

          while true; do
            # Check if the emulator is listed and is now online
            if adb devices |grep -m 1 "emulator-" | grep -q "device"; then
             echo "Emulator is ready and online!"
             break
            fi

            # Check if the timeout has been reached
            CURRENT_TIME=$(date +%s)
            if [ "$CURRENT_TIME" -ge "$((START_TIME + 180))" ]; then 
              echo 'Emulator did not start in time...'; 
              echo 'Checking emulator logs...'
              cat emulator.log
              exit 1
            fi

            STATUS=$(adb devices | grep -m 1 "emulator-" | awk '{print $2}')
            echo "Still waiting for emulator to be ready (current status: $STATUS)..."
            sleep 5; 
           done

      
          if ! adb devices | grep -q "emulator-.*offline"; then
            echo "Emulator did not start correctly. Check emulator logs for details."
            cat emulator.log
            exit 1
          fi
 
          echo "‚úÖ Emulator is ready!"
 
      - name: List installed Appium drivers
        run: appium driver list --installed
 
      - name: Fix Permissions
        run: chmod +x node_modules/.bin/wdio
 
      - name: üß™ Run WebdriverIO Tests
        run: npx wdio wdio.conf.js
 
      - name: üì¶ Upload Logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs
          path: logs
