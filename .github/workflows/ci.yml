name: Mobile automation test
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
        - name: ‚¨áÔ∏è Checkout Code
          uses: actions/checkout@v4

        - name: üê¢ Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: 18

        - name: Clean node_modules and package-lock.json
          run:
            rm -rf node_modules
            rm package-lock.json
            npm install # Reinstall dependencies cleanly

        - name: üèóÔ∏è Install Dependencies
          run: npm install

        - name: Install Appium and drivers
          run: 
            npm install -g appium
            npm install appium-uiautomator2-driver
            appium driver install uiautomator2

        - name: Set up Java
          run: sudo apt-get install openjdk-11-jdk

        - name: Install Android SDK
          run: |
            sudo apt-get update
            sudo apt-get install -y android-sdk
            export ANDROID_HOME=/usr/lib/android-sdk
            export PATH=$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$PATH

        - name: Set up Android Emulator
          run: |
            echo no | android update sdk --no-ui --filter "tools, platform-tools, build-tools, android-29"
            echo no | android create avd --name test_avd --target android 29 --abi armeabi-v7a --device 1
            emulator -avd test_avd -no-window & # Start the emulator
            adb devices # Check if the emulator is connected
            sleep 30 # Give time for emulator to start up

        - name: List installed Appium drivers
          run: appium driver list --installed

        - name: Fix Permissions
          run: chmod +x node_modules/.bin/wdio

        - name: üß™ Run WebdriverIO Tests
          run: npx wdio wdio.conf.js

        - name: üì¶ Upload Logs
          uses: actions/upload-artifact@v4
          if: failure()
          with:
            name: logs
            path: logs
